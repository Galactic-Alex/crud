<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<body>
<div class="container-fluid p-0">

    <div class="row">
        <div class="flex-column align-content w-100">
            <div class="text-white bg-dark p-2">
                <span class="text-white bg-dark font-weight-bold" id="user-name-span"></span>
                <span>user with roles:</span>
                <span id="user-roles-span"></span>
                <span class="text float-right justify-content-end">Logout</span>
            </div>
        </div>
    </div>

    <div class="modal fade" id="edit-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modal-title">Edit User</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row justify-content-center">
                            <span class="col col-md-auto">ID</span>
                        </div>
                        <div class="row justify-content-center">
                            <label class="col col-md-auto">
                                <input type="text" disabled id="modal-input-id">
                            </label>
                        </div>
                        <div class="row justify-content-center">
                            <span class="col col-md-auto">Name</span>
                        </div>
                        <div class="row justify-content-center">
                            <label class="col col-md-auto">
                                <input type="text" minlength="2" id="modal-input-name">
                            </label>
                        </div>
                        <div class="row justify-content-center">
                            <span class="col col-md-auto">Email</span>
                        </div>
                        <div class="row justify-content-center">
                            <label class="col col-md-auto">
                                <input type="email"  minlength="5" id="modal-input-email">
                            </label>
                        </div>
                        <div class="row justify-content-center">
                            <span class="col col-md-auto">Age</span>
                        </div>
                        <div class="row justify-content-center">
                            <label class="col col-md-auto">
                                <input type="number" maxlength="3" minlength="2" id="modal-input-age">
                            </label>
                        </div>
                        <div class="row justify-content-center">
                            <span class="col col-md-auto">Role</span>
                        </div>
                        <div class="row justify-content-center">
                            <select class="col form-select col-md-auto" multiple id="modal-input-role">
                                <option value="1">
                                    ADMIN
                                </option>
                                <option>
                                    USER
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button data-bs-dismiss="modal" class="btn" id="modal-edit-button">Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row" style="height: 100vh">
        <div class="flex-column bg-white" style="width: 15rem;" id="all-button-div">
            <div class="text text-white bg-primary p-2 active" id="admin-button-div" hidden>
                Admin
            </div>
            <div class="text text-primary p-2 active" id="user-button-div">
                User
            </div>
        </div>

        <div class="col bg-light p-3" id="table-div">
        </div>
    </div>

</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

</body>

<script>

    $.getJSON("user/getCurrUser", function (data) {
        let isUserAdmin = false;
        $("#user-name-span").append(data.name);

        for (let i = 0; i < data.roles.length; i++) {
            if (data.roles[i].role === "ROLE_ADMIN") {
                $("#admin-button-div").removeAttr("hidden");
                isUserAdmin = true;
            }
            $("#user-roles-span").append(data.roles[i].role.replace("ROLE_", " "));
        }

        if (!isUserAdmin) {
            $("#user-button-div").click();
        } else {
            $("#table-div").load("admin/page #admin-page-div");
            parseAllUsers();
        }

    });

    $(document).ready(function () {
        $("#user-button-div").click(function pressUserButton() {
            if ($("#user-button-div").is('.active')) {
                $("#table-div").load("user/page #user-page-div");
                $.getJSON("user/getCurrUser", function (data) {
                    parseCurrJsonUser(data)
                });
                $(this).toggleClass('text-white text-primary bg-primary active');
                $("#admin-button-div").toggleClass('text-white text-primary bg-primary');
                if (!$("#admin-button-div").is('.active')) {
                    $("#admin-button-div").toggleClass('active')
                }
            }
        }).hover(function () {
            $(this).toggleClass('text-primary text-white bg-dark');
        });
    });

    $(document).ready(function () {
        $("#admin-button-div").hover(function () {
            $(this).toggleClass('text-primary text-white bg-dark');
        }).click(function () {
            if ($("#admin-button-div").is('.active')) {
                $("#table-div").load("admin/page #admin-page-div");
                parseAllUsers();
                $(this).toggleClass('text-white text-primary bg-primary active');
                $("#user-button-div").toggleClass('text-white text-primary bg-primary');
                if (!$("#user-button-div").is('.active')) {
                    $("#user-button-div").toggleClass('active')
                }
            }
        });
        $("#modal-edit-button").click(function () {
            if ($("#modal-edit-button").text().includes("Edit")) {
                let object = {};
                object.id = $("#modal-input-id").val();
                object.name = $("#modal-input-name").val();
                object.age = $("#modal-input-age").val();
                object.email = $("#modal-input-email").val();
                object.roles = [];
                object.roles[0] = "ROLE_USER";
                if ($("#modal-input-role").find("option:selected").text().includes("ADMIN")) {
                    object.roles[1] = "ROLE_ADMIN";
                }
                saveUser(object);
            } else {
                deleteStudent($("#modal-input-id").val());
            }
        });
    });

    function parseCurrJsonUser(user) {
        let tr = [];
        tr.push("<tr>");
        tr.push("<td>" + user.id + "</td>");
        tr.push("<td>" + user.name + "</td>");
        tr.push("<td>" + user.email + "</td>");
        tr.push("<td>" + user.age + "</td>");
        tr.push("<td>");
        for (let i = 0; i < user.roles.length; i++) {
            tr.push(user.roles[i].role.replace("ROLE_", " "))
        }
        tr.push("</td>");
        tr.push("</tr>");
        $("#user-page-table-tbody").append(tr.join(''));
    }

    function parseJsonUserForAdmin(user) {
        let tr = [];
        tr.push("<tr class=\"border-top\">");
        tr.push("<td>" + user.id + "</td>");
        tr.push("<td>" + user.name + "</td>");
        tr.push("<td>" + user.email + "</td>");
        tr.push("<td>" + user.age + "</td>");
        tr.push("<td>");
        for (let i = 0; i < user.roles.length; i++) {
            tr.push(user.roles[i].role.replace("ROLE_", " "))
        }
        tr.push("</td>");
        tr.push('<td> <input class=\"btn border-0 text-white bg-info\" type=\"button" data-bs-toggle="modal" data-bs-target="#edit-modal" onclick="editStudent('
            + user.id
            + ');" value="Edit"></td>');
        tr.push('<td> <input class=\"btn border-0 text-white bg-danger\" type=\"button" data-bs-toggle="modal" data-bs-target="#edit-modal" onclick="deleteStudentButton('
            + user.id
            + ');" value="Delete"></td>');
        tr.push("</tr>");
        $("#admin-page-table-tbody").append(tr.join(''));
    }

    function parseAllUsers() {
        $.getJSON("admin/getAllUsers", function (jsons) {
            $("#admin-page-table-tbody").empty();
            for (let i = 0; i < jsons.length; i++) {
                parseJsonUserForAdmin(jsons[i]);
            }
        });
    }

    function editStudent(id) {
        $.getJSON("admin/getOneUser/" + id, function (user) {
            $('#modal-h2').text("Edit User");
            $("#modal-input-id").val(user.id);
            $("#modal-input-name").val(user.name).prop('disabled', false);
            $("#modal-input-email").val(user.email).prop('disabled', false);
            $("#modal-input-age").val(user.age).prop('disabled', false);
            $("#modal-input-role").prop('disabled', false);
            $("#modal-edit-button").text("Edit").addClass("btn-primary").removeClass("btn-danger");
        });
    }

    function deleteStudentButton(id) {
        $.getJSON("admin/getOneUser/" + id, function (user) {
            $('#modal-h2').text("Delete User");
            $("#modal-input-id").val(user.id);
            $("#modal-input-name").val(user.name).prop('disabled', true);
            $("#modal-input-email").val(user.email).prop('disabled', true);
            $("#modal-input-age").val(user.age).prop('disabled', true);
            $("#modal-input-role").prop('disabled', true);
            $("#modal-edit-button").text("Delete").removeClass("btn-primary").addClass("btn-danger");
        });
    }

    function deleteStudent(id) {
        $.post("admin/deleteUser/" + id, function () {
            parseAllUsers();
        });
    }

    function saveUser(object) {
        $.post("admin/saveUser", object, function() {
            parseAllUsers();
        });
    }

</script>

</html>